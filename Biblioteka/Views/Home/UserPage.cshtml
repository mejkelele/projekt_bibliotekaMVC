@model Biblioteka.Models.User
@using Microsoft.AspNetCore.Mvc.Rendering
@using System.Security.Claims
@{
    ViewData["Title"] = "Panel Użytkownika";
    // Pobieranie danych z ViewBag (zapewnione przez HomeController)
    var aktywneWypozyczenia = ViewBag.AktywneWypozyczenia as List<Biblioteka.Models.Wypozyczenie>;
    var aktywneRezerwacje = ViewBag.AktywneRezerwacje as List<Biblioteka.Models.Rezerwacja>;
    var historiaWypozyczen = ViewBag.HistoriaWypozyczen as List<Biblioteka.Models.Wypozyczenie>;
    var okresyPrzedluzenia = ViewBag.OkresyPrzedluzenia as SelectList;
    var maxKsiazek = 5; // Maksymalna liczba książek do wypożyczenia
}

<div class="container">
    <h1>Witaj, @Model.Imie!</h1>
    
    @if (TempData["Message"] != null)
    {
        <div class="alert alert-info mt-3">@((string)TempData["Message"]!)</div>
    }

    <div class="card my-4">
        <div class="card-header bg-primary text-white">
            Informacje o Koncie
        </div>
        <div class="card-body">
            <p><strong>Imię i Nazwisko:</strong> @Model.Imie @Model.Nazwisko</p>
            <p><strong>Email:</strong> @Model.email</p>
            <p><strong>Rola:</strong> @Model.Rola</p>

            @* Status Długu/Kary *@
            <p>
                <strong>Zadłużenie/Kara:</strong> 
                <span class="badge @(Model.Kara > 0 ? "bg-danger" : "bg-success")">
                    @Model.Kara.ToString("C") @* Formatowanie jako waluta *@
                </span>
            </p>

            @* Status Blokady Wypożyczeń *@
            @if (Model.IsBlocked)
            {
                <p>
                    <strong>Status Wypożyczeń:</strong> 
                    <span class="badge bg-danger">KONTO ZABLOKOWANE</span>
                </p>
            }

            <p>
                <strong>Aktualna Liczba Wypożyczonych Książek:</strong> 
                <span class="badge @(Model.iloscWypKsiazek >= maxKsiazek || Model.IsBlocked ? "bg-danger" : "bg-info")">
                    @Model.iloscWypKsiazek z @maxKsiazek
                </span>
            </p>

            @if (!Model.IsBlocked)
            {
                if (Model.iloscWypKsiazek < maxKsiazek)
                {
                    <span class="text-success">Możesz wypożyczyć jeszcze @(maxKsiazek - Model.iloscWypKsiazek) książek.</span>
                }
                else
                {
                    <span class="text-danger">Osiągnąłeś/aś limit wypożyczeń.</span>
                }
            }
            else
            {
                <span class="text-danger">Nie możesz wypożyczać z powodu blokady konta.</span>
            }
        </div>
    </div>

    <h3 class="mt-4">Aktywne Wypożyczenia</h3>
    @if (aktywneWypozyczenia != null && aktywneWypozyczenia.Any())
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Tytuł Książki</th>
                    <th>Data Wypożyczenia</th>
                    <th>Oczekiwany Zwrot</th>
                    <th>Przedłużono</th>
                    <th>Akcje</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var wypozyczenie in aktywneWypozyczenia)
                {
                    var isOverdue = wypozyczenie.OczekiwanaDataZwrotu < DateTime.Now;
                    <tr class="@(isOverdue ? "table-danger" : "")">
                        <td>@wypozyczenie.Ksiazka?.tytul</td>
                        <td>@wypozyczenie.DataWypozyczenia.ToShortDateString()</td>
                        <td>
                            @wypozyczenie.OczekiwanaDataZwrotu.ToShortDateString()
                            @(isOverdue ? "(PRZETERMINOWANA)" : "")
                        </td>
                        <td>@(wypozyczenie.Przedluzono ? "Tak" : "Nie")</td>
                        <td>
                            @if (!wypozyczenie.Przedluzono && !isOverdue)
                            {
                                <form asp-controller="Wypozyczenie" asp-action="Extend" method="post" asp-route-wypozyczenieId="@wypozyczenie.Id" class="d-inline">
                                    <div class="input-group">
                                        @* Używamy asp-items dla poprawnego bindowania *@
                                        <select name="dni" class="form-select form-select-sm" style="width: auto;" asp-items="@ViewBag.OkresyPrzedluzenia"></select>
                                        <button type="submit" class="btn btn-sm btn-warning">Przedłuż</button>
                                    </div>
                                </form>
                            }
                            else if (isOverdue)
                            {
                                <span class="text-danger">Zwróć natychmiast</span>
                            }
                            else
                            {
                                <span class="text-muted">Przedłużenie wykorzystane</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="alert alert-success">Brak aktywnych wypożyczeń.</div>
    }

    <h3 class="mt-4">Aktywne Rezerwacje</h3>
    @if (aktywneRezerwacje != null && aktywneRezerwacje.Any())
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Książka</th>
                    <th>Data Rezerwacji</th>
                    <th>Status</th>
                    <th>Odbiór Wygasa</th>
                    <th>Akcje</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var rezerwacja in aktywneRezerwacje)
                {
                    // FIX CS1061/CS0019: Używamy .HasValue i .Value dla DataWygasniecia
                    var isReady = rezerwacja.DataWygasniecia.HasValue && rezerwacja.DataWygasniecia.Value > DateTime.MinValue;
                    var isExpired = isReady && rezerwacja.DataWygasniecia.Value < DateTime.Now; 
                    
                    <tr class="@(isReady ? "table-success" : "") @(isExpired ? "table-warning" : "")">
                        <td>@rezerwacja.Ksiazka?.tytul</td>
                        <td>@rezerwacja.DataRezerwacji.ToShortDateString()</td>
                        <td>
                            @if (isReady)
                            {
                                <span class="badge bg-success">GOTOWA DO ODBIORU</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">W KOLEJCE</span>
                            }
                        </td>
                        <td>
                            @if (isReady)
                            {
                                @rezerwacja.DataWygasniecia!.Value.ToShortDateString() 
                                @(isExpired ? "(WYGASŁA)" : "")
                            }
                            else
                            {
                                <span>---</span>
                            }
                        </td>
                        <td>
                            @* Użytkownik może anulować swoją rezerwację z poziomu profilu *@
                            <form asp-controller="Rezerwacja" asp-action="Cancel" method="post" asp-route-id="@rezerwacja.Id" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-danger" 
                                        onclick="return confirm('Czy na pewno chcesz anulować rezerwację na @rezerwacja.Ksiazka?.tytul?');">
                                    Anuluj
                                </button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="alert alert-info">Brak aktywnych rezerwacji.</div>
    }

    <h3 class="mt-4">Historia Wypożyczeń (Zwrócone Książki)</h3>
    @if (historiaWypozyczen != null && historiaWypozyczen.Any())
    {
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Tytuł Książki</th>
                    <th>Wypożyczenie</th>
                    <th>Oczekiwany Zwrot</th>
                    <th>Faktyczny Zwrot</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var wypozyczenie in historiaWypozyczen.OrderByDescending(w => w.FaktycznaDataZwrotu))
                {
                    @* FIX: Porównanie dat odbywa się na Value.Date *@
                    var isOverdue = wypozyczenie.FaktycznaDataZwrotu.HasValue && 
                                    wypozyczenie.FaktycznaDataZwrotu.Value.Date > wypozyczenie.OczekiwanaDataZwrotu.Date;
                    
                    <tr class="@(isOverdue ? "table-warning" : "table-light")">
                        <td>@wypozyczenie.Ksiazka?.tytul</td>
                        <td>@wypozyczenie.DataWypozyczenia.ToShortDateString()</td>
                        <td>@wypozyczenie.OczekiwanaDataZwrotu.ToShortDateString()</td>
                        <td>@wypozyczenie.FaktycznaDataZwrotu?.ToShortDateString()</td>
                        <td>
                            @if (isOverdue)
                            {
                                <span class="badge bg-danger">ZWROT PO TERMINIE</span>
                            }
                            else
                            {
                                <span class="badge bg-success">ZWROT NA CZAS</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="alert alert-info">Brak zakończonych wypożyczeń w historii.</div>
    }

    <div class="mt-5">
        <a asp-controller="Ksiazka" asp-action="Index" class="btn btn-primary btn-lg">Przeglądaj Katalog</a>
    </div>

</div>